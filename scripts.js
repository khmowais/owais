function escapeHtml(e){return e.replace(/[&<>"]/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[e]||e)))}function renderMarkdown(e){try{return e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\r/g,"")).replace(/```([\s\S]*?)```/g,((e,t)=>`<pre style="background:#121212;padding:16px;border-radius:8px;overflow:auto"><code>${escapeHtml(t)}</code></pre>`))).replace(/^### (.*$)/gim,"<h3>$1</h3>")).replace(/^## (.*$)/gim,"<h2>$1</h2>")).replace(/^# (.*$)/gim,"<h1>$1</h1>")).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")).replace(/\*(.*?)\*/g,"<em>$1</em>")).replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')).replace(/^\s*[-\*] (.*)/gm,"<li>$1</li>")).replace(/^\s*\d+\. (.*)/gm,"<li>$1</li>")).replace(/(<li>.*<\/li>\n?)+/g,(e=>e.includes("<li>")&&e.match(/^\d+\./m)?`<ol>${e}</ol>`:`<ul>${e}</ul>`))).replace(/^> (.*$)/gim,"<blockquote>$1</blockquote>")).replace(/^(?!<h|<ul|<ol|<pre|<blockquote|<img)(.+)$/gm,(e=>""===e.trim()?"":`<p>${e}</p>`))}catch(e){return console.error("Error rendering markdown:",e),'<div class="loading">Error rendering post content. Please try another post.</div>'}}async function loadPosts(){const e=document.getElementById("postList");if(e){e.innerHTML='<div class="small">Loading posts…</div>';try{const t=await fetch("posts/posts.json",{cache:"no-store"});if(!t.ok)throw new Error(`Failed to fetch posts.json: ${t.status} ${t.statusText}`);const n=await t.json();if(!Array.isArray(n)||0===n.length)return void(e.innerHTML='<div class="small">No posts found in posts/posts.json</div>');e.innerHTML="",n.sort(((e,t)=>new Date(t.date||"1970-01-01")-new Date(e.date||"1970-01-01")));for(const t of n){if(!t.file||!t.title){console.warn("Invalid post entry:",t);continue}const n=document.createElement("div");n.className="post-preview",n.tabIndex=0,n.innerHTML=`<div style="font-weight:700;font-size:16px">${escapeHtml(t.title)}</div><div class="small" style="margin-top:8px">${escapeHtml(t.date||"")}</div>`,n.addEventListener("click",(()=>{window.location.href=`blog.html?post=${encodeURIComponent(t.file)}`})),n.addEventListener("keydown",(e=>"Enter"===e.key&&(window.location.href=`blog.html?post=${encodeURIComponent(t.file)}`))),e.appendChild(n)}e.hasChildNodes()||(e.innerHTML='<div class="small">No valid posts found in posts/posts.json</div>')}catch(t){e.innerHTML='<div class="small">Could not load posts. Ensure <code>posts/posts.json</code> exists and is valid JSON. <a href="index.html">Return to home</a>.</div>',console.error("Error loading posts:",t)}}else console.warn("Post list element (#postList) not found")}async function loadBlogPost(){const e=document.getElementById("postContent"),t=document.getElementById("articleTitle"),n=document.getElementById("articleAuthor"),o=document.getElementById("articleDate"),s=document.getElementById("articleTags"),i=document.getElementById("relatedPosts");if(!(e&&t&&n&&o&&s&&i))return void console.error("Required elements missing");const a=new URLSearchParams(window.location.search).get("post");if(!a)return e.innerHTML='<div class="loading">No post specified. Please select a post from the <a href="index.html#thoughts">posts list</a>.</div>',void console.warn("No post parameter in URL");e.innerHTML='<div class="loading">Loading post: '+escapeHtml(a)+"…</div>";try{const r=await fetch("posts/posts.json",{cache:"no-store"});if(!r.ok)throw new Error(`Failed to fetch posts.json: ${r.status} ${r.statusText}`);const l=await r.json(),c=l.find((e=>e.file===a));if(!c)throw new Error(`Post ${a} not found in posts.json`);const d=await fetch(`posts/${a}`,{cache:"no-store"});if(!d.ok)throw new Error(`Failed to fetch post ${a}: ${d.status} ${d.statusText}`);const m=await d.text();if(!m.trim())throw new Error("Post content is empty");t.textContent=c.title||"Untitled",n.textContent=c.author||"Khawaja M. Owais",o.textContent=c.date?new Date(c.date).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"--",s.innerHTML="",c.tags&&Array.isArray(c.tags)&&c.tags.forEach((e=>{const t=document.createElement("a");t.className="tag",t.textContent=e,t.href=`index.html#thoughts?tag=${encodeURIComponent(e)}`,s.appendChild(t)})),i.innerHTML="";const u=l.filter((e=>e.file!==a&&e.tags&&e.tags.some((e=>c.tags&&c.tags.includes(e))))).slice(0,3);if(0===u.length){const e=l.filter((e=>e.file!==a)).sort(((e,t)=>new Date(t.date||"1970-01-01")-new Date(e.date||"1970-01-01"))).slice(0,3);u.push(...e)}u.forEach((e=>{const t=document.createElement("li"),n=document.createElement("a");n.href=`blog.html?post=${encodeURIComponent(e.file)}`,n.textContent=e.title,t.appendChild(n),i.appendChild(t)})),0===u.length&&(i.innerHTML="<li>No related posts found.</li>"),e.innerHTML=renderMarkdown(m),updateReadingTime(e),updateReadingProgress(),initHighlighting()}catch(t){e.innerHTML=`<div class="loading">Unable to load post: ${escapeHtml(a)}. <a href="index.html#thoughts">Return to posts</a>.</div>`,console.error("Error loading post:",t)}}function updateReadingTime(e){const t=document.getElementById("readingTime");if(!t)return;const n=e.innerText.split(/\s+/).length,o=Math.ceil(n/200);t.textContent=`${o} min`}function updateReadingProgress(){const e=document.querySelector(".reading-progress-bar");if(!e)return;const t=document.getElementById("postContent");t&&window.addEventListener("scroll",(()=>{const{top:n,height:o}=t.getBoundingClientRect(),s=window.innerHeight,i=document.documentElement.scrollHeight-s,a=window.pageYOffset||document.documentElement.scrollTop,r=100*Math.min(1,Math.max(0,a/i));e.style.width=`${r}%`}))}let isHighlighting=!1;function initHighlighting(){const e=document.getElementById("postContent");e&&e.addEventListener("mousedown",(t=>{if(!isHighlighting)return;t.preventDefault();const n=window.getSelection();n.removeAllRanges(),e.addEventListener("mouseup",(()=>{if(n.toString().trim()){const e=n.getRangeAt(0),t=document.createElement("span");t.className="highlight";try{e.surroundContents(t)}catch(e){console.warn("Highlighting failed:",e)}n.removeAllRanges()}}),{once:!0})}))}function toggleHighlight(){isHighlighting=!isHighlighting;const e=document.querySelector('.tool-btn[title="Highlight text"]');e&&e.classList.toggle("active",isHighlighting),showToast(isHighlighting?"✏️ Highlighting enabled":"✏️ Highlighting disabled")}function openSearch(){const e=document.getElementById("searchModal"),t=document.getElementById("searchInput");e&&t&&(e.classList.toggle("active"),e.classList.contains("active")?(t.focus(),searchInArticle()):(t.value="",document.getElementById("searchResults").innerHTML=""))}function searchInArticle(){const e=document.getElementById("searchInput"),t=document.getElementById("searchResults"),n=document.getElementById("postContent");e&&t&&n&&e.addEventListener("input",(()=>{const o=e.value.toLowerCase().trim();if(t.innerHTML="",!o)return;const s=getTextNodes(n).filter((e=>e.textContent.toLowerCase().includes(o)));0!==s.length?s.forEach(((e,n)=>{const o=document.createElement("div");o.className="search-result",o.textContent=e.textContent.substring(0,100)+(e.textContent.length>100?"...":""),o.addEventListener("click",(()=>{e.parentElement.scrollIntoView({behavior:"smooth",block:"center"});const t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();n.removeAllRanges(),n.addRange(t)})),t.appendChild(o)})):t.innerHTML='<div class="search-result">No matches found</div>'}))}function getTextNodes(e){const t=[],n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let o;for(;o=n.nextNode();)o.textContent.trim()&&t.push(o);return t}function subscribe(e){e.preventDefault();const t=document.getElementById("subscribeEmail")?.value.trim();t?fetch("subscribe.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({email:t})}).then((e=>{e.ok?(showToast("✅ Subscribed successfully!"),document.getElementById("subscribeForm").reset()):showToast("⚠️ Failed to subscribe. Please try again later.")})).catch((e=>{showToast("❌ Error subscribing. Check your internet connection."),console.error("Subscription error:",e)})):showToast("⚠️ Please enter a valid email address.")}function copyToClipboard(e){navigator.clipboard.writeText(e).then((()=>{showToast("📋 Email copied to clipboard!")})).catch((t=>{console.error("Clipboard error:",t),prompt("Copy this:",e)}))}function sendMessage(e){e.preventDefault();const t=document.getElementById("name")?.value.trim(),n=document.getElementById("email")?.value.trim(),o=document.getElementById("subject")?.value.trim(),s=document.getElementById("message")?.value.trim();t&&n&&s&&o?fetch("sendmail.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({name:t,email:n,subject:o,message:s})}).then((e=>{e.ok?(showToast("✅ Message sent successfully!"),document.querySelector(".contact-form")?.reset()):showToast("⚠️ Failed to send message. Please try again later.")})).catch((e=>{showToast("❌ Error sending message. Check your internet connection."),console.error("Form submission error:",e)})):showToast("⚠️ Please fill all form fields.")}function showToast(e){const t=document.getElementById("toast");t?(t.textContent=e,t.classList.add("show"),setTimeout((()=>t.classList.remove("show")),4e3)):console.warn("Toast element (#toast) not found")}function initServicesFilter(){const e=document.querySelectorAll("#services .filter-button"),t=document.querySelectorAll("#services .tile");e.forEach((n=>{n.addEventListener("click",(()=>{e.forEach((e=>e.classList.remove("active"))),n.classList.add("active");const o=n.getAttribute("data-filter");t.forEach((e=>{const t=e.getAttribute("data-category");e.classList.toggle("hidden","all"!==o&&t!==o)}))}))}))}function initParticles(){"undefined"!=typeof particlesJS?particlesJS("particles-js",{particles:{number:{value:80,density:{enable:!0,value_area:800}},color:{value:"#00ffcc"},shape:{type:"circle",stroke:{width:0}},opacity:{value:.3,random:!0,anim:{enable:!0,speed:1,opacity_min:.1}},size:{value:3,random:!0},line_linked:{enable:!0,distance:150,color:"#00ffcc",opacity:.2,width:1},move:{enable:!0,speed:2,direction:"none",random:!0,out_mode:"out"}},interactivity:{detect_on:"canvas",events:{onhover:{enable:!0,mode:"grab"},onclick:{enable:!0,mode:"push"},resize:!0},modes:{grab:{distance:140,line_linked:{opacity:.5}},push:{particles_nb:4}}},retina_detect:!0}):console.warn("particles.js not loaded")}function initAnimations(){if("undefined"==typeof AOS)return void console.warn("AOS not loaded");AOS.init({duration:800,easing:"ease-out-cubic",once:!0});const e=document.querySelectorAll(".fade-in"),t=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&e.target.classList.add("visible")}))}),{threshold:.2});e.forEach((e=>t.observe(e)))}function changeFontSize(e){const t=document.getElementById("postContent");if(!t)return;const n=parseInt(window.getComputedStyle(t).fontSize)||16,o=Math.max(12,Math.min(24,n+e));t.style.fontSize=`${o}px`;const s=document.getElementById("fontSize");s&&(s.textContent=`${o}px`)}function toggleTheme(){document.body.classList.toggle("light");const e=document.body.classList.contains("light");localStorage.setItem("theme",e?"light":"dark");const t=document.getElementById("themeIcon");t&&(t.className=e?"bi bi-sun-fill":"bi bi-moon-stars-fill")}document.addEventListener("DOMContentLoaded",(()=>{if(document.getElementById("particles-js")&&initParticles(),initAnimations(),document.getElementById("postList")&&loadPosts(),document.getElementById("postContent")){loadBlogPost();if("light"===localStorage.getItem("theme")){document.body.classList.add("light");const e=document.getElementById("themeIcon");e&&(e.className="bi bi-sun-fill")}document.addEventListener("keydown",(e=>{e.ctrlKey&&"k"===e.key&&(e.preventDefault(),openSearch())}))}document.getElementById("services")&&initServicesFilter()}));